<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cronometraje Piston Rodeo (Offline persistente)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Iconos para iOS / navegadores -->
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />

  <!-- jsPDF local, sin CDN (solo para exportar PDF; el resto funciona sin él) -->
  <script src="jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1rem;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    .panel {
      background: #ffffff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
    }
    input, select, button, textarea {
      margin-top: 0.25rem;
      padding: 0.4rem 0.6rem;
      font-size: 0.95rem;
    }
    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      min-height: 100px;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background: #1976d2;
      color: white;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    button.secondary {
      background: #555;
    }
    button.danger {
      background: #d32f2f;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .col {
      flex: 1 1 260px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      text-align: center;
    }
    th {
      background: #eeeeee;
    }
    .small-text {
      font-size: 0.8rem;
      color: #555;
    }
    .badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: #1976d2;
      color: white;
      font-size: 0.75rem;
    }
    .status {
      margin-top: 0.5rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>Cronometraje Piston Rodeo</h1>

  <div class="panel">
    <h2>1. Precargar dorsales y categorías</h2>
    <p class="small-text">
      Formato: <strong>dorsal;nombre;categoría</strong> (una línea por piloto).
      
    </p>
    <textarea id="inputDorsales" placeholder="1;Piloto 1;MX1&#10;2;Piloto 2;MX2"></textarea>
    <button id="btnCargarDorsales">Cargar dorsales</button>
    
    <p id="infoDorsales" class="small-text"></p>
  </div>

  <div class="panel">
    <h2>2. Control de carrera</h2>
    <div class="row">
      <div class="col">
        <button id="btnIniciarCarrera">Iniciar carrera</button>
        
        <button id="btnDeshacerPaso" class="secondary">Deshacer último paso</button>
        <p id="estadoCarrera" class="status">Carrera no iniciada.</p>
      </div>
      <div class="col">
        <label for="inputPasoDorsal">Registrar paso por meta (dorsal)</label>
        <input type="number" id="inputPasoDorsal" placeholder="Escribe dorsal y pulsa Enter" />
        <button id="btnRegistrarPaso">Registrar paso</button>
        <p class="small-text">
</p>
      </div>
    </div>
    <p id="ultimoPaso" class="small-text"></p>
  </div>

  <div class="panel">
    <h2>3. Clasificación en vivo</h2>
    <div class="row">
      <div class="col">
        <label for="filtroCategoria">Filtrar por categoría</label>
        <select id="filtroCategoria">
          <option value="TODAS">Todas las categorías</option>
        </select>
      </div>
    </div>
    <br />
    <table>
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody id="tablaClasificacion"></tbody>
    </table>
  </div>

  <div class="panel">
    <h2>4. Exportar resultados a PDF</h2>
    <div class="row">
      <div class="col">
        <button id="btnExportGeneral">Exportar PDF general</button>
      </div>
      <div class="col">
        <label for="categoriaPDF">Categoría para exportar</label>
        <select id="categoriaPDF">
          <option value="">-- Selecciona categoría --</option>
        </select>
        <button id="btnExportCategoria">Exportar PDF por categoría</button>
      </div>
    </div>
    <p class="small-text">
      Clasificación ordenada por número de vueltas, tiempos por vuelta y diferencia respecto al líder.
    </p>
  </div>

  <script>
    // --- Estado principal ---
    let carreraIniciada = false;
    let inicioCarreraMs = null;
    const historialPasos = [];
    const pilotos = new Map();

    // --- Persistencia en localStorage ---
    const STORAGE_KEY = "pistonRodeo_state_v1";

    function formatearTiempo(ms) {
      if (ms == null) return "-";
      const totalSeg = Math.floor(ms / 1000);
      const minutos = Math.floor(totalSeg / 60);
      const segundos = totalSeg % 60;
      const centesimas = Math.floor((ms % 1000) / 10);
      const pad = function(n, size) { return n.toString().padStart(size, "0"); };
      return pad(minutos, 2) + ":" + pad(segundos, 2) + "." + pad(centesimas, 2);
    }

    function saveState() {
      try {
        const pilotosArray = [];
        pilotos.forEach(function(p) {
          pilotosArray.push({
            dorsal: p.dorsal,
            nombre: p.nombre,
            categoria: p.categoria,
            pasos: p.pasos
          });
        });

        const data = {
          carreraIniciada: carreraIniciada,
          inicioCarreraMs: inicioCarreraMs,
          historialPasos: historialPasos,
          pilotos: pilotosArray
        };

        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("No se pudo guardar el estado:", e);
      }
    }

    function restoreState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);

        carreraIniciada = !!data.carreraIniciada;
        inicioCarreraMs = (data.inicioCarreraMs !== undefined) ? data.inicioCarreraMs : null;

        // Restaurar historial
        historialPasos.length = 0;
        if (data.historialPasos && data.historialPasos.length) {
          data.historialPasos.forEach(function(h) { historialPasos.push(h); });
        }

        // Restaurar pilotos
        pilotos.clear();
        if (data.pilotos && data.pilotos.length) {
          data.pilotos.forEach(function(p) {
            const pasos = [];
            if (p.pasos && p.pasos.length) {
              p.pasos.forEach(function(paso) {
                pasos.push({
                  vuelta: paso.vuelta,
                  tiempoMs: paso.tiempoMs,
                  tiempoTexto: paso.tiempoTexto || formatearTiempo(paso.tiempoMs)
                });
              });
            }
            pilotos.set(String(p.dorsal), {
              dorsal: String(p.dorsal),
              nombre: p.nombre || "",
              categoria: p.categoria || "",
              pasos: pasos
            });
          });
        }

        actualizarSelectCategorias();
        refrescarTabla();
        refrescarUltimoPasoLabel();

        const estado = document.getElementById("estadoCarrera");
        if (carreraIniciada && inicioCarreraMs != null) {
          estado.textContent =
            "Carrera en marcha (recuperada). Inicio: " +
            new Date(inicioCarreraMs).toLocaleTimeString();
        } else {
          estado.textContent = "Preparado. Datos recuperados de la última sesión.";
        }
      } catch (e) {
        console.warn("No se pudo restaurar el estado:", e);
      }
    }

    window.addEventListener("load", restoreState);

    // --- Categorías ---
    function actualizarSelectCategorias() {
      const categorias = new Set();
      pilotos.forEach(function(p) { categorias.add(p.categoria); });

      const filtro = document.getElementById("filtroCategoria");
      const catPDF = document.getElementById("categoriaPDF");
      filtro.innerHTML = '<option value="TODAS">Todas las categorías</option>';
      catPDF.innerHTML = '<option value="">-- Selecciona categoría --</option>';

      categorias.forEach(function(cat) {
        if (!cat) return;
        const opt1 = document.createElement("option");
        opt1.value = cat;
        opt1.textContent = cat;
        filtro.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = cat;
        opt2.textContent = cat;
        catPDF.appendChild(opt2);
      });
    }

    // --- Clasificación ---
    function obtenerClasificacion(filtroCategoria) {
      if (!filtroCategoria) filtroCategoria = "TODAS";
      const lista = [];
      pilotos.forEach(function(p) {
        if (filtroCategoria !== "TODAS" && p.categoria !== filtroCategoria) return;
        const vueltas = p.pasos.length;
        const ultimoPaso = vueltas > 0 ? p.pasos[p.pasos.length - 1].tiempoMs : null;
        lista.push({
          dorsal: p.dorsal,
          nombre: p.nombre,
          categoria: p.categoria,
          vueltas: vueltas,
          ultimoPasoMs: ultimoPaso
        });
      });

      lista.sort(function(a, b) {
        if (a.vueltas !== b.vueltas) return b.vueltas - a.vueltas;
        if (a.ultimoPasoMs == null && b.ultimoPasoMs == null) return 0;
        if (a.ultimoPasoMs == null) return 1;
        if (b.ultimoPasoMs == null) return -1;
        return a.ultimoPasoMs - b.ultimoPasoMs;
      });

      return lista;
    }

    function calcularDatosLider(clasificacion) {
      const lider = clasificacion.find(function(p) { return p.vueltas > 0 && p.ultimoPasoMs != null; });
      if (!lider) return { vueltasLider: 0, tiempoLider: null };
      return { vueltasLider: lider.vueltas, tiempoLider: lider.ultimoPasoMs };
    }

    function calcularGapTexto(piloto, vueltasLider, tiempoLider) {
      if (!tiempoLider || piloto.vueltas === 0 || piloto.ultimoPasoMs == null) return "-";
      if (piloto.vueltas < vueltasLider) {
        const diffVueltas = vueltasLider - piloto.vueltas;
        return "+" + diffVueltas + " vuelta" + (diffVueltas > 1 ? "s" : "");
      }
      const diffMs = piloto.ultimoPasoMs - tiempoLider;
      if (diffMs <= 0) return "Líder";
      return "+" + formatearTiempo(diffMs);
    }

    function obtenerTiempoVuelta(pilotoObj, numVuelta) {
      const pasos = pilotoObj.pasos;
      if (!pasos || pasos.length < numVuelta) return null;
      if (numVuelta === 1) {
        return pasos[0].tiempoMs;
      } else {
        return pasos[numVuelta - 1].tiempoMs - pasos[numVuelta - 2].tiempoMs;
      }
    }

    function refrescarUltimoPasoLabel() {
      if (historialPasos.length === 0) {
        document.getElementById("ultimoPaso").textContent = "";
        return;
      }
      const ultima = historialPasos[historialPasos.length - 1];
      const piloto = pilotos.get(ultima.dorsal);
      if (!piloto || piloto.pasos.length === 0) {
        document.getElementById("ultimoPaso").textContent = "";
        return;
      }
      const paso = piloto.pasos[piloto.pasos.length - 1];
      document.getElementById("ultimoPaso").textContent =
        "Último paso: dorsal " + piloto.dorsal +
        " | vuelta " + paso.vuelta +
        " | tiempo " + paso.tiempoTexto;
    }

    function refrescarTabla() {
      const filtroCat = document.getElementById("filtroCategoria").value;
      const tbody = document.getElementById("tablaClasificacion");
      const headerRow = document.getElementById("headerRow");
      tbody.innerHTML = "";
      headerRow.innerHTML = "";

      const clasificacion = obtenerClasificacion(filtroCat);
      const datosLider = calcularDatosLider(clasificacion);
      const vueltasLider = datosLider.vueltasLider;
      const tiempoLider = datosLider.tiempoLider;

      let maxVueltas = 0;
      clasificacion.forEach(function(p) {
        if (p.vueltas > maxVueltas) maxVueltas = p.vueltas;
      });

      const headersBase = ["Pos", "Dorsal", "Nombre", "Categoría", "Vueltas"];
      headersBase.forEach(function(text) {
        const th = document.createElement("th");
        th.textContent = text;
        headerRow.appendChild(th);
      });

      for (let i = 1; i <= maxVueltas; i++) {
        const th = document.createElement("th");
        th.textContent = "V" + i;
        headerRow.appendChild(th);
      }

      const thGap = document.createElement("th");
      thGap.textContent = "Dif. líder";
      headerRow.appendChild(thGap);

      clasificacion.forEach(function(p, idx) {
        const tr = document.createElement("tr");
        const pilotoObj = pilotos.get(p.dorsal);

        const tdPos = document.createElement("td");
        tdPos.textContent = p.vueltas > 0 ? (idx + 1) : "-";

        const tdDorsal = document.createElement("td");
        tdDorsal.innerHTML = '<span class="badge">' + p.dorsal + '</span>';

        const tdNombre = document.createElement("td");
        tdNombre.textContent = p.nombre || "-";

        const tdCat = document.createElement("td");
        tdCat.textContent = p.categoria || "-";

        const tdVueltas = document.createElement("td");
        tdVueltas.textContent = p.vueltas;

        tr.appendChild(tdPos);
        tr.appendChild(tdDorsal);
        tr.appendChild(tdNombre);
        tr.appendChild(tdCat);
        tr.appendChild(tdVueltas);

        for (let i = 1; i <= maxVueltas; i++) {
          const tdLap = document.createElement("td");
          const tLap = pilotoObj ? obtenerTiempoVuelta(pilotoObj, i) : null;
          tdLap.textContent = formatearTiempo(tLap);
          tr.appendChild(tdLap);
        }

        const tdGap = document.createElement("td");
        tdGap.textContent = calcularGapTexto(p, vueltasLider, tiempoLider);
        tr.appendChild(tdGap);

        tbody.appendChild(tr);
      });
    }

    // --- Eventos de carga de dorsales ---
    document.getElementById("btnCargarDorsales").addEventListener("click", function () {
      const texto = document.getElementById("inputDorsales").value.trim();
      const info = document.getElementById("infoDorsales");
      if (!texto) {
        info.textContent = "No hay datos para cargar.";
        return;
      }

      // Reinicio completo de carrera y participantes
      carreraIniciada = false;
      inicioCarreraMs = null;
      historialPasos.length = 0;
      pilotos.clear();

      let count = 0;
      const lineas = texto.split("\n");
      lineas.forEach(function (linea) {
        const limpio = linea.trim();
        if (!limpio) return;
        const partes = limpio.split(";");
        const dorsal = (partes[0] || "").trim();
        const nombre = (partes[1] || "").trim();
        const categoria = (partes[2] || "").trim();
        if (!dorsal) return;
        pilotos.set(dorsal, {
          dorsal: dorsal,
          nombre: nombre,
          categoria: categoria,
          pasos: []
        });
        count++;
      });

      // Reset visual del estado de carrera
      const estado = document.getElementById("estadoCarrera");
      if (estado) estado.textContent = "Carrera no iniciada.";
      const ultimo = document.getElementById("ultimoPaso");
      if (ultimo) ultimo.textContent = "";

      info.textContent = "Se han cargado " + count + " pilotos (reinicio completo).";
      actualizarSelectCategorias();
      refrescarTabla();
      saveState();
    });

    

    // --- Control de carrera ---
    document.getElementById("btnIniciarCarrera").addEventListener("click", function () {
      inicioCarreraMs = Date.now();
      carreraIniciada = true;
      historialPasos.length = 0;
      pilotos.forEach(function (p) {
        p.pasos = [];
      });
      document.getElementById("estadoCarrera").textContent =
        "Carrera en marcha. Inicio: " + new Date(inicioCarreraMs).toLocaleTimeString();
      document.getElementById("ultimoPaso").textContent = "";
      refrescarTabla();
      saveState();
    });

    

    function registrarPaso() {
      const input = document.getElementById("inputPasoDorsal");
      const dorsal = input.value.trim();
      if (!carreraIniciada || inicioCarreraMs == null) {
        alert("Primero debes iniciar la carrera.");
        return;
      }
      if (!dorsal) return;

      let piloto = pilotos.get(dorsal);
      if (!piloto) {
        piloto = {
          dorsal: dorsal,
          nombre: "",
          categoria: "",
          pasos: []
        };
        pilotos.set(dorsal, piloto);
        actualizarSelectCategorias();
      }

      const ahora = Date.now();
      const tiempoMs = ahora - inicioCarreraMs;
      const vuelta = piloto.pasos.length + 1;

      const paso = {
        vuelta: vuelta,
        tiempoMs: tiempoMs,
        tiempoTexto: formatearTiempo(tiempoMs)
      };
      piloto.pasos.push(paso);

      historialPasos.push({ dorsal: dorsal });

      document.getElementById("ultimoPaso").textContent =
        "Último paso: dorsal " + dorsal +
        " | vuelta " + vuelta +
        " | tiempo " + paso.tiempoTexto;

      input.value = "";
      input.focus();
      refrescarTabla();
      saveState();
    }

    document.getElementById("btnRegistrarPaso").addEventListener("click", registrarPaso);

    document.getElementById("inputPasoDorsal").addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
        registrarPaso();
      }
    });

    document.getElementById("btnDeshacerPaso").addEventListener("click", function () {
      if (historialPasos.length === 0) {
        alert("No hay pasos para deshacer.");
        return;
      }
      const ultimo = historialPasos.pop();
      const piloto = pilotos.get(ultimo.dorsal);
      if (piloto && piloto.pasos.length > 0) {
        piloto.pasos.pop();
      }
      refrescarUltimoPasoLabel();
      refrescarTabla();
      saveState();
    });

    document.getElementById("filtroCategoria").addEventListener("change", refrescarTabla);

    // --- Exportar PDF ---
    async function exportarPDF(config) {
      const titulo = config.titulo;
      const categoriaFiltro = config.categoriaFiltro || "TODAS";

      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("No se ha podido cargar jsPDF (jspdf.umd.min.js). El resto de la aplicación funciona igual.");
        return;
      }

      const jsPDF = window.jspdf.jsPDF;
      const doc = new jsPDF({ orientation: "landscape" });

      const margenX = 10;
      let posY = 15;

      doc.setFontSize(14);
      doc.text(titulo, margenX, posY);
      posY += 6;

      const ahora = new Date().toLocaleString();
      doc.setFontSize(10);
      doc.text("Generado: " + ahora, margenX, posY);
      posY += 8;

      doc.setFontSize(8);

      const clasificacion = obtenerClasificacion(categoriaFiltro);
      const datosLider = calcularDatosLider(clasificacion);
      const vueltasLider = datosLider.vueltasLider;
      const tiempoLider = datosLider.tiempoLider;

      let maxVueltas = 0;
      clasificacion.forEach(function (p) {
        if (p.vueltas > maxVueltas) maxVueltas = p.vueltas;
      });

      const headersBase = ["Pos", "Dorsal", "Nombre", "Cat", "Vts"];
      const headersVueltas = [];
      for (let i = 1; i <= maxVueltas; i++) {
        headersVueltas.push("V" + i);
      }
      const headersFinales = ["Gap"];
      const headers = headersBase.concat(headersVueltas).concat(headersFinales);

      const pageWidth = doc.internal.pageSize.getWidth();
      const anchoTotal = pageWidth - 2 * margenX;
      const baseWidths = [10, 14, 50, 20, 10];
      const anchoBaseUsado = baseWidths.reduce(function (a, b) { return a + b; }, 0);
      const numColsExtra = headersVueltas.length + headersFinales.length;
      const anchoExtra = Math.max(10, Math.floor((anchoTotal - anchoBaseUsado) / Math.max(1, numColsExtra)));

      const widths = baseWidths
        .concat(Array(headersVueltas.length).fill(anchoExtra))
        .concat(Array(headersFinales.length).fill(anchoExtra));

      const startX = margenX;

      function dibujarFila(valores, y) {
        let x = startX;
        valores.forEach(function (v, idx) {
          doc.text(String(v), x, y);
          x += widths[idx];
        });
      }

      dibujarFila(headers, posY);
      posY += 6;
      doc.setLineWidth(0.1);
      doc.line(margenX, posY - 4, margenX + widths.reduce(function (a, b) { return a + b; }, 0), posY - 4);

      clasificacion.forEach(function (p, index) {
        if (posY > doc.internal.pageSize.getHeight() - 15) {
          doc.addPage();
          posY = 15;
          dibujarFila(headers, posY);
          posY += 6;
          doc.line(margenX, posY - 4, margenX + widths.reduce(function (a, b) { return a + b; }, 0), posY - 4);
        }

        const pilotoObj = pilotos.get(p.dorsal);
        const pos = p.vueltas > 0 ? (index + 1) : "-";
        const gapTxt = calcularGapTexto(p, vueltasLider, tiempoLider);

        const fila = [
          pos,
          p.dorsal,
          (p.nombre || ""),
          (p.categoria || ""),
          p.vueltas
        ];

        for (let i = 1; i <= maxVueltas; i++) {
          const tLap = pilotoObj ? obtenerTiempoVuelta(pilotoObj, i) : null;
          fila.push(formatearTiempo(tLap));
        }

        fila.push(gapTxt);

        dibujarFila(fila, posY);
        posY += 5;
      });

      let nombreArchivo = "resultados_piston_rodeo_persistente";
      if (categoriaFiltro !== "TODAS") {
        nombreArchivo += "_cat_" + categoriaFiltro.replace(/\s+/g, "_");
      }
      nombreArchivo += ".pdf";

      // --- Descarga/compartir PDF compatible con iPhone (Safari) ---
      try {
        const pdfBlob = doc.output("blob");

        // iOS: si está disponible, usar hoja de compartir con archivo real
        const file = new File([pdfBlob], nombreArchivo, { type: "application/pdf" });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ files: [file], title: nombreArchivo });
        } else {
          // Fallback universal: abrir PDF en nueva pestaña
          const url = URL.createObjectURL(pdfBlob);
          const opened = window.open(url, "_blank");

          // Fallback extra si window.open se bloquea: link temporal
          if (!opened) {
            const a = document.createElement("a");
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            a.remove();
          }

          setTimeout(() => URL.revokeObjectURL(url), 60000);
        }
      } catch (e) {
        // Último recurso: método clásico
        doc.save(nombreArchivo);
      }

    }

    document.getElementById("btnExportGeneral").addEventListener("click", function () {
      exportarPDF({ titulo: "Resultados generales Piston Rodeo", categoriaFiltro: "TODAS" });
    });

    document.getElementById("btnExportCategoria").addEventListener("click", function () {
      const cat = document.getElementById("categoriaPDF").value;
      if (!cat) {
        alert("Selecciona una categoría para exportar.");
        return;
      }
      exportarPDF({ titulo: "Resultados Piston Rodeo - Categoría: " + cat, categoriaFiltro: cat });
    });

    // Inicializar tabla vacía (por si no hay nada en localStorage)
    refrescarTabla();
  </script>
</body>
</html>
